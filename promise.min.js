/*! jstool-promise 2015-03-27 */
!function(a,b){"undefined"==typeof window?"undefined"!=typeof module&&(module.exports=a()):b.fn?fn.define("qPromise",function(){return a(b)}):b.qPromise||(b.qPromise=a(b))}(function(a){function b(a,b){b instanceof Function&&setTimeout(function(){b.apply(a,[function(b){a.resolve(b)},function(b){a.reject(b)}])},0)}function c(a,b){for(var c=a.shift();a.length;){if(c[b])return c;c=a.shift()}return c&&c[b]?c:!1}function d(a,b,d,e){var f=c(a.queue,d);if(f)a["[[PromiseStatus]]"]=b,void 0!==e&&(a["[[PromiseValue]]"]=e);else{for(f=a.queue.finally.shift();f;)f(e),f=c(a.queue.finally,d);f=!1}if(f&&f[d]){try{var g=f[d].call(a,e);a["[[PromiseStatus]]"]="fulfilled"}catch(h){a["[[PromiseStatus]]"]="rejected",a["[[PromiseValue]]"]=h,g=h}if(g&&g.then instanceof Function)g.then(function(b){return a.resolve(b),b},function(b){throw a.reject(b),b});else switch(a["[[PromiseStatus]]"]){case"fulfilled":a.resolve(void 0===g?e:g);break;case"rejected":a.reject(void 0===g?e:g)}}return a}function e(a,c){a.queue=[],a.queue.finally=[],a["[[PromiseStatus]]"]="pending",a["[[PromiseValue]]"]=void 0,b(a,c)}function f(b){return void 0===this||this===a?new f(b):void e(this,b)}return f.prototype.then=function(a,b){return this.queue.push({then:a instanceof Function?a:!1,"catch":b instanceof Function?b:!1}),this},f.prototype.catch=function(a){return a instanceof Function&&this.queue.push({"catch":a}),this},f.prototype.finally=function(a){return a instanceof Function&&this.queue.finally.push(a),this},f.prototype.resolve=function(a){return d(this,"fulfilled","then",a)},f.prototype.reject=function(a){return d(this,"rejected","catch",a)},f.defer=function(){var a=new f;return a.promise=a,a},f.when=function(a){var b=new f(function(c,d){a&&a.then?a.then(c,d):c(b,a)});return b},f.all=function(a){return a=a instanceof Array?a:[],new f(function(b,c){if(!a.length)return void b();var d=0,e=[];e.length=a.length,a.forEach(function(a,f){if(!(a instanceof Object&&a.then))throw{promise:a,error:"is not a promise"};d++,a.then(function(a){console.log("resolved promise",f),e[f]=a,d--,d||b(e)},c)})})},f},this);